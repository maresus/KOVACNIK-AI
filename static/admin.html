<!DOCTYPE html>
<html lang="sl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kovaƒçnik ‚Äì Rezervacije</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --brand: #7b5e3b;
      --bg: #f5f4f1;
      --card: #fff;
      --muted: #7a7a7a;
      --border: #e6e2da;
      --shadow: 0 10px 30px rgba(0,0,0,0.06);
      --radius: 14px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: #1b1f1a;
      line-height: 1.6;
      padding-bottom: 32px;
    }
    .page {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      padding: 18px 20px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 18px;
    }
    .title { font-size: 1.3rem; font-weight: 700; display: flex; gap: 10px; align-items: center; }
    .subtitle { color: var(--muted); font-size: 0.95rem; }
    .chip { background: #f2ede6; color: #5b4327; padding: 6px 10px; border-radius: 999px; font-weight: 600; }
    .btn {
      border: none;
      cursor: pointer;
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: 600;
      display: inline-flex;
      gap: 8px;
      align-items: center;
      transition: transform 0.05s ease, box-shadow 0.2s ease;
      background: var(--brand);
      color: #fff;
      box-shadow: 0 8px 20px rgba(123,94,59,0.25);
    }
    .btn.secondary { background: #f1ede5; color: #4b3a28; box-shadow: none; }
    .btn:hover { transform: translateY(-1px); }

    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    .stat {
      background: var(--card);
      padding: 14px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: grid;
      gap: 6px;
    }
    .stat .label { color: var(--muted); font-size: 0.9rem; }
    .stat .value { font-size: 1.8rem; font-weight: 700; color: var(--brand); }
    .stat .hint { color: var(--muted); font-size: 0.85rem; }

    /* Filters */
    .filters {
      background: var(--card);
      padding: 14px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      display: grid;
      gap: 12px;
      margin-bottom: 16px;
    }
    .filter-row {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    }
    select, input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      font-size: 14px;
    }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }

    /* Table */
    .table-wrap {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    table { width: 100%; border-collapse: collapse; min-width: 960px; }
    th, td { padding: 12px 14px; text-align: left; border-bottom: 1px solid #f0ede8; vertical-align: top; }
    th { background: #faf8f4; font-size: 13px; color: #5f5a54; font-weight: 700; }
    tbody tr:hover { background: #f9f7f2; }
    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .status-pending { background: #fff4d6; color: #8a6500; }
    .status-confirmed { background: #d7f2dd; color: #226536; }
    .status-rejected { background: #fbe0e0; color: #9a1f1f; }
    .status-processing { background: #e3ecff; color: #2f54a3; }
    .type-room { color: #50351e; }
    .type-table { color: #134f2b; }
    .muted { color: var(--muted); font-size: 12px; }
    .tooltip { max-width: 240px; }
    .btn-inline {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      color: #4b3a28;
    }
    .btn-inline.danger { color: #b3261e; border-color: #f3c7c2; }
    .btn-inline.success { color: #1f7a3c; border-color: #b7e3c6; }

    /* Modal */
    .modal {
      position: fixed; inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.35);
      z-index: 1000;
      padding: 16px;
    }
    .modal.active { display: flex; }
    .modal-body {
      background: #fff;
      border-radius: 16px;
      max-width: 720px;
      width: 100%;
      max-height: 90vh;
      overflow: auto;
      padding: 20px;
      box-shadow: var(--shadow);
      display: grid;
      gap: 12px;
    }
    .modal-title { font-size: 1.2rem; font-weight: 700; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; }
    .form-group { display: grid; gap: 6px; }
    label { font-weight: 600; font-size: 13px; color: #3b2d1e; }
    textarea { min-height: 90px; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 8px; }

    @media (max-width: 960px) {
      table { min-width: 0; }
      th, td { font-size: 13px; }
      .table-wrap { overflow-x: auto; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <div>
        <div class="title">üè† Kovaƒçnik - Rezervacije</div>
        <div class="subtitle" id="current-date"></div>
      </div>
      <div class="actions">
        <button class="btn secondary" onclick="exportCsv()">üì• Izvozi CSV</button>
        <button class="btn" onclick="loadAll()">üîÑ Osve≈æi podatke</button>
      </div>
    </header>

    <div class="stats" id="stats-cards">
      <div class="stat"><div class="label">Danes</div><div class="value" id="stat-danes">0</div><div class="hint">Rezervacije</div></div>
      <div class="stat"><div class="label">Ta teden</div><div class="value" id="stat-teden">0</div><div class="hint">Rezervacije</div></div>
      <div class="stat"><div class="label">Ta mesec</div><div class="value" id="stat-mesec">0</div><div class="hint">Rezervacije</div></div>
      <div class="stat"><div class="label">Potrjenih</div><div class="value" id="stat-confirmed">0</div></div>
      <div class="stat"><div class="label">ƒåaka</div><div class="value" id="stat-pending">0</div></div>
      <div class="stat"><div class="label">üõèÔ∏è Sobe</div><div class="value" id="stat-room">0</div></div>
      <div class="stat"><div class="label">üçΩÔ∏è Mize</div><div class="value" id="stat-table">0</div></div>
    </div>

    <div class="filters">
      <div class="filter-row">
        <select id="filter-status">
          <option value="">Vsi statusi</option>
          <option value="pending" selected>ƒåaka</option>
          <option value="processing">V obdelavi</option>
          <option value="confirmed">Potrjeno</option>
          <option value="rejected">Zavrnjeno</option>
        </select>
        <select id="filter-type">
          <option value="">Vsi tipi</option>
          <option value="room">Sobe</option>
          <option value="table">Mize</option>
        </select>
        <select id="filter-source">
          <option value="">Vsi viri</option>
          <option value="chat">Chatbot</option>
          <option value="wordpress_room">WP Sobe</option>
          <option value="wordpress_table">WP Mize</option>
        </select>
        <input type="date" id="filter-date-from" />
        <input type="date" id="filter-date-to" />
      </div>
      <div class="actions">
        <button class="btn" onclick="loadAll()">Filtriraj</button>
        <button class="btn secondary" onclick="resetFilters()">Ponastavi</button>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Datum</th>
            <th>Gost</th>
            <th>Kontakt</th>
            <th>Tip</th>
            <th>Osebe</th>
            <th>Otroci</th>
            <th>Soba/ƒåas</th>
            <th>Opombe</th>
            <th>Status</th>
            <th>Akcije</th>
          </tr>
        </thead>
        <tbody id="reservations-table"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="edit-modal">
    <div class="modal-body">
      <div class="modal-title">Uredi rezervacijo #<span id="edit-id"></span></div>
      <form id="edit-form">
        <input type="hidden" id="edit-reservation-id" />
        <div class="form-grid">
          <div class="form-group">
            <label>Status</label>
            <select id="edit-status">
              <option value="pending">ƒåaka</option>
              <option value="processing">V obdelavi</option>
              <option value="confirmed">Potrjeno</option>
              <option value="rejected">Zavrnjeno</option>
            </select>
          </div>
          <div class="form-group">
            <label>Tip</label>
            <select id="edit-type">
              <option value="room">Soba</option>
              <option value="table">Miza</option>
            </select>
          </div>
          <div class="form-group">
            <label>Datum</label>
            <input type="text" id="edit-date" />
          </div>
          <div class="form-group">
            <label>ƒåas (mize)</label>
            <input type="text" id="edit-time" />
          </div>
          <div class="form-group">
            <label>Noƒçitve</label>
            <input type="number" id="edit-nights" />
          </div>
          <div class="form-group">
            <label>Sobe</label>
            <input type="number" id="edit-rooms" />
          </div>
          <div class="form-group">
            <label>Osebe</label>
            <input type="number" id="edit-people" />
          </div>
          <div class="form-group">
            <label>Otroci (≈°t.)</label>
            <input type="text" id="edit-kids" />
          </div>
          <div class="form-group">
            <label>Starost otrok</label>
            <input type="text" id="edit-kids-ages" />
          </div>
          <div class="form-group">
            <label>Soba / Lokacija</label>
            <input type="text" id="edit-location" />
          </div>
          <div class="form-group">
            <label>Ime</label>
            <input type="text" id="edit-name" />
          </div>
          <div class="form-group">
            <label>Email</label>
            <input type="email" id="edit-email" />
          </div>
          <div class="form-group">
            <label>Telefon</label>
            <input type="text" id="edit-phone" />
          </div>
          <div class="form-group">
            <label>Opombe</label>
            <textarea id="edit-note"></textarea>
          </div>
          <div class="form-group">
            <label>Admin opombe</label>
            <textarea id="edit-admin-notes"></textarea>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn secondary" onclick="closeModal()">Prekliƒçi</button>
          <button type="submit" class="btn">üíæ Shrani</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const API_BASE = '/api/admin';

    const qs = id => document.getElementById(id);
    document.getElementById('current-date').textContent = new Date().toLocaleDateString('sl-SI', { weekday:'short', day:'2-digit', month:'2-digit', year:'numeric' });

    document.addEventListener('DOMContentLoaded', () => {
      loadAll();
      setInterval(loadStats, 60000);
    });

    async function loadAll() {
      await Promise.all([loadStats(), loadReservations()]);
    }

    function resetFilters() {
      qs('filter-status').value = 'pending';
      qs('filter-type').value = '';
      qs('filter-source').value = '';
      qs('filter-date-from').value = '';
      qs('filter-date-to').value = '';
      loadAll();
    }

    function buildQuery() {
      const status = qs('filter-status').value;
      const type = qs('filter-type').value;
      const source = qs('filter-source').value;
      const date_from = qs('filter-date-from').value;
      const date_to = qs('filter-date-to').value;
      const params = new URLSearchParams();
      params.set('limit', '200');
      if (status) params.set('status', status);
      if (type) params.set('type', type);
      if (source) params.set('source', source);
      if (date_from) params.set('date_from', date_from);
      if (date_to) params.set('date_to', date_to);
      return params.toString();
    }

    async function loadStats() {
      try {
        const res = await fetch(`${API_BASE}/stats`);
        const data = await res.json();
        qs('stat-danes').textContent = data.danes ?? 0;
        qs('stat-teden').textContent = data.ta_teden ?? 0;
        qs('stat-mesec').textContent = data.ta_mesec ?? 0;
        qs('stat-confirmed').textContent = data.po_statusu?.confirmed ?? 0;
        qs('stat-pending').textContent = data.po_statusu?.pending ?? 0;
        qs('stat-room').textContent = data.po_tipu?.room ?? 0;
        qs('stat-table').textContent = data.po_tipu?.table ?? 0;
      } catch (e) {
        console.error('Stats error', e);
      }
    }

    async function loadReservations() {
      const query = buildQuery();
      try {
        const res = await fetch(`${API_BASE}/reservations?${query}`);
        const data = await res.json();
        renderReservations(data.reservations || []);
      } catch (e) {
        console.error('Load reservations error', e);
      }
    }

    function renderReservations(list) {
      const tbody = qs('reservations-table');
      if (!list.length) {
        tbody.innerHTML = `<tr><td colspan="11" style="text-align:center;padding:32px;color:${'#8a8378'}">Ni rezervacij</td></tr>`;
        return;
      }
      tbody.innerHTML = list.map(r => `
        <tr>
          <td>#${r.id}</td>
          <td>
            <strong>${r.date || '-'}</strong>
            ${r.nights ? `<div class="muted">${r.nights} noƒçi</div>` : ''}
            ${r.time ? `<div class="muted">${r.time}</div>` : ''}
          </td>
          <td>
            <div><strong>${r.name || '-'}</strong></div>
            ${r.country ? `<div class="muted">${r.country}</div>` : ''}
          </td>
          <td>
            ${r.email ? `<a href="mailto:${r.email}">${r.email}</a>` : '-'}
            ${r.phone ? `<div class="muted">${r.phone}</div>` : ''}
          </td>
          <td>${r.reservation_type === 'room' ? 'üõèÔ∏è Soba' : 'üçΩÔ∏è Miza'}</td>
          <td>
            ${r.people || '-'}${r.rooms ? `, ${r.rooms} sob` : ''}
            ${r.kids ? `<div class="muted">${r.kids} otrok</div>` : ''}
          </td>
          <td>${r.kids_small || '-'}</td>
          <td>${r.location || r.time || '-'}</td>
          <td title="${r.note || ''}" class="tooltip">${r.note ? (r.note.length > 35 ? r.note.slice(0,35)+'‚Ä¶' : r.note) : '-'}</td>
          <td>${renderStatus(r.status)}</td>
          <td style="display:flex;gap:6px;flex-wrap:wrap;">
            <button class="btn-inline success" onclick="confirmReservation(${r.id})">‚úÖ</button>
            <button class="btn-inline danger" onclick="rejectReservation(${r.id})">‚ùå</button>
            <button class="btn-inline" onclick="openEdit(${encodeURIComponent(JSON.stringify(r))})">‚úèÔ∏è</button>
          </td>
        </tr>
      `).join('');
    }

    function renderStatus(status) {
      const cls = status ? `status-${status}` : '';
      const label = status === 'pending' ? 'ƒåaka' :
                    status === 'confirmed' ? 'Potrjeno' :
                    status === 'rejected' ? 'Zavrnjeno' :
                    status === 'processing' ? 'V obdelavi' : status || '-';
      return `<span class="badge ${cls}">${label}</span>`;
    }

    async function confirmReservation(id) {
      await fetch(`${API_BASE}/reservations/${id}/confirm`, { method: 'POST' });
      loadAll();
    }
    async function rejectReservation(id) {
      await fetch(`${API_BASE}/reservations/${id}/reject`, { method: 'POST' });
      loadAll();
    }

    function openEdit(dataStr) {
      const r = JSON.parse(decodeURIComponent(dataStr));
      qs('edit-id').textContent = r.id;
      qs('edit-reservation-id').value = r.id;
      qs('edit-status').value = r.status || 'pending';
      qs('edit-type').value = r.reservation_type || 'room';
      qs('edit-date').value = r.date || '';
      qs('edit-time').value = r.time || '';
      qs('edit-nights').value = r.nights || '';
      qs('edit-rooms').value = r.rooms || '';
      qs('edit-people').value = r.people || '';
      qs('edit-kids').value = r.kids || '';
      qs('edit-kids-ages').value = r.kids_small || '';
      qs('edit-location').value = r.location || '';
      qs('edit-name').value = r.name || '';
      qs('edit-email').value = r.email || '';
      qs('edit-phone').value = r.phone || '';
      qs('edit-note').value = r.note || '';
      qs('edit-admin-notes').value = r.admin_notes || '';
      qs('edit-modal').classList.add('active');
    }
    function closeModal() { qs('edit-modal').classList.remove('active'); }

    qs('edit-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = qs('edit-reservation-id').value;
      const payload = {
        status: qs('edit-status').value,
        date: qs('edit-date').value,
        time: qs('edit-time').value,
        nights: parseInt(qs('edit-nights').value || '0') || null,
        rooms: parseInt(qs('edit-rooms').value || '0') || null,
        people: parseInt(qs('edit-people').value || '0') || null,
        kids: qs('edit-kids').value || null,
        kids_small: qs('edit-kids-ages').value || null,
        location: qs('edit-location').value || null,
        name: qs('edit-name').value || null,
        email: qs('edit-email').value || null,
        phone: qs('edit-phone').value || null,
        note: qs('edit-note').value || null,
        admin_notes: qs('edit-admin-notes').value || null,
        reservation_type: qs('edit-type').value,
      };
      await fetch(`${API_BASE}/reservations/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      closeModal();
      loadAll();
    });

    async function exportCsv() {
      const query = buildQuery();
      const res = await fetch(`${API_BASE}/export?${query}`);
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'reservations.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
